<!-- online_consultations/templates/online_consultations/consultation_detail.html -->

{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</h1>
<p>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: {{ consultation.slot.specialist.user.get_full_name }}</p>
<p>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: {{ consultation.slot.start_time|date:"d M Y H:i" }}</p>

<div style="display: flex; justify-content: space-between;">
    <div id="video-container" style="flex-grow: 1; margin-right: 20px;">
        <video id="localVideo" autoplay muted style="width: 100%; height: auto;"></video>
        <video id="remoteVideo" autoplay style="width: 100%; height: auto;"></video>
    </div>

    <div id="chat-container" style="width: 300px; border: 1px solid #ccc; padding: 10px;">
        <ul id="message-list" style="list-style: none; padding: 0; height: 400px; overflow-y: scroll;">
        </ul>
        <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="width: 100%;">
        <button id="emoji-trigger">üòä</button>
        <button onclick="sendMessage();">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <input type="file" id="file-input">
        <button onclick="sendFile(document.getElementById('file-input').files[0]);">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
    </div>
</div>

<div id="participant-names" style="text-align: center; margin-top: 10px;">
    <p>–í—ã: {{ request.user.get_full_name }}</p>
    <p>–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: {{ consultation.slot.specialist.user.get_full_name }}</p>
</div>

<script src="{% static 'js/consultation.js' %}"></script>
<script src="{% static 'js/webrtc.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/@emoji-picker-element/emoji-picker-element@3/dist/emoji-picker.min.js"></script>
<script type="text/javascript">
    startWebSocket({{ consultation.id }});
    startVideoCall();
    setupEmojiPicker(); // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–º–∞–π–ª–∏–∫–æ–≤

    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Å—Ç—É–ø–∏–ª–æ –ª–∏ –≤—Ä–µ–º—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é
        const startTime = new Date("{{ consultation.slot.start_time|date:'c' }}").getTime();
        const now = new Date().getTime();
        if (now >= startTime && "{{ consultation.video_call_link }}") {
            const videoContainer = document.getElementById('video-container');
            videoContainer.innerHTML = '<a href="{{ consultation.video_call_link }}" target="_blank">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≤–∏–¥–µ–æ-–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏</a>';
        }
    });

    function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value;
        consultationSocket.send(JSON.stringify({ 'message': message }));
        messageInput.value = '';
    }

    function sendFile() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (file) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ –¥—Ä—É–≥–æ–π –º–µ—Ö–∞–Ω–∏–∑–º
        }
    }
</script>

{% endblock %}
