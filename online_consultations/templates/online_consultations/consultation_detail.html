<!-- online_consultations/templates/online_consultations/consultation_detail.html -->

{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>Консультация</h1>
<p>Специалист: {{ consultation.slot.specialist.user.get_full_name }}</p>
<p>Время начала: {{ consultation.slot.start_time|date:"d M Y H:i" }}</p>

<div id="video-container" style="text-align: center; width: 100%;">
    <video id="localVideo" autoplay muted style="width: 49%; height: auto;"></video>
    <video id="remoteVideo" autoplay style="width: 49%; height: auto;"></video>
</div>

<div id="participant-names" style="text-align: center; margin-top: 10px;">
    <p>Вы: {{ request.user.get_full_name }}</p>
    <p>Специалист: {{ consultation.slot.specialist.user.get_full_name }}</p>
</div>

<div id="messages">
    <ul id="message-list">
    </ul>
</div>

<input type="text" id="message-input" placeholder="Введите сообщение...">
<button onclick="sendMessage();">Отправить</button>

<script src="{% static 'js/consultation.js' %}"></script>
<script src="{% static 'js/webrtc.js' %}"></script>
<script type="text/javascript">
    startWebSocket({{ consultation.id }});
    startVideoCall();

    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем, наступило ли время консультации, и добавляем ссылку на видео-конференцию
        const startTime = new Date("{{ consultation.slot.start_time|date:'c' }}").getTime();
        const now = new Date().getTime();
        if (now >= startTime && "{{ consultation.video_call_link }}") {
            const videoContainer = document.getElementById('video-container');
            videoContainer.innerHTML = '<a href="{{ consultation.video_call_link }}" target="_blank">Присоединиться к видео-конференции</a>';
        }
    });
</script>

{% endblock %}
